{# Reusable JavaScript for dynamic question and answer forms #}
<script>
// Constants for validation
const MINIMUM_ANSWER_COUNT = 2;

document.addEventListener('DOMContentLoaded', function() {
    initializeDynamicForms();
});

function initializeDynamicForms() {
    const questionsCollection = document.querySelector('.questions-collection');
    const addQuestionButton = document.querySelector('.add-question');
    
    if (addQuestionButton && questionsCollection) {
        addQuestionButton.addEventListener('click', function() {
            addQuestion(questionsCollection);
        });
    }
    
    // Initialize existing questions
    initializeExistingQuestions();
}

function initializeExistingQuestions() {
    // Add event listeners to existing remove question buttons
    document.querySelectorAll('.remove-question').forEach(function(button) {
        button.addEventListener('click', function() {
            removeQuestion(button);
        });
    });
    
    // Add event listeners to existing add answer buttons
    document.querySelectorAll('.add-answer').forEach(function(button) {
        button.addEventListener('click', function() {
            const questionItem = button.closest('.question-item');
            if (questionItem) {
                const answersCollection = questionItem.querySelector('.answers-collection');
                if (answersCollection) {
                    addAnswer(answersCollection);
                }
            }
        });
    });
    
    // Add event listeners to existing remove answer buttons
    document.querySelectorAll('.remove-answer').forEach(function(button) {
        button.addEventListener('click', function() {
            removeAnswer(button);
        });
    });
}

function addQuestion(collection) {
    if (!collection) {
        console.error('Questions collection not found');
        return;
    }
    
    const prototype = collection.getAttribute('data-prototype');
    if (!prototype) {
        console.error('No prototype found for questions collection');
        return;
    }
    
    let index = parseInt(collection.getAttribute('data-index'));
    if (isNaN(index) || index < 0) {
        index = 0;
    }
    
    let newForm = prototype.replace(/__name__/g, index);
    
    const wrapper = document.createElement('div');
    wrapper.classList.add('collection-item', 'question-item');
    wrapper.setAttribute('data-question-index', index + 1);
    wrapper.innerHTML = newForm;
    
    // Add question number badge for styled version
    const existingBadge = wrapper.querySelector('.question-number-badge');
    if (!existingBadge) {
        const badge = document.createElement('div');
        badge.className = 'question-number-badge';
        
        const icon = document.createElement('i');
        icon.className = 'bi bi-question-circle-fill';
        badge.appendChild(icon);
        badge.appendChild(document.createTextNode(' Question #' + (index + 1)));
        
        wrapper.insertBefore(badge, wrapper.firstChild);
    }
    
    // Apply consistent styling to form fields in the dynamically added question
    applyQuestionFieldStyling(wrapper);
    
    // Initialize the answers collection in the new question
    // Try to find by class first, then by data-prototype attribute (for dynamically added questions)
    let answersCollection = wrapper.querySelector('.answers-collection');
    if (!answersCollection) {
        // Look for the CollectionType for answers by finding an element with data-prototype
        // that contains 'answers' in the field name pattern
        const potentialCollections = wrapper.querySelectorAll('[data-prototype]');
        for (const collection of potentialCollections) {
            // Check if this is nested within the question (not the questions collection itself)
            if (wrapper.contains(collection) && collection !== wrapper) {
                // Additional check: verify this is the answers collection by checking the prototype content
                const prototypeContent = collection.getAttribute('data-prototype');
                if (prototypeContent && prototypeContent.includes('[answers]')) {
                    answersCollection = collection;
                    // Add the class for consistency
                    answersCollection.classList.add('answers-collection');
                    break;
                }
            }
        }
    }
    
    if (answersCollection) {
        const currentAnswerIndex = answersCollection.getAttribute('data-index');
        if (!currentAnswerIndex || isNaN(parseInt(currentAnswerIndex))) {
            answersCollection.setAttribute('data-index', '0');
        }
        
        // Add answers header if it doesn't exist
        // NOTE: This header is needed for dynamically added questions since the prototype
        // only contains form fields, not the surrounding template markup.
        // For questions loaded from the server, the header already exists in the template.
        const parentNode = answersCollection.parentNode;
        if (parentNode) {
            const existingHeader = parentNode.querySelector('.answers-header');
            if (!existingHeader) {
                const answersHeader = document.createElement('div');
                answersHeader.className = 'answers-header';
                
                // Create icon element
                const icon = document.createElement('i');
                icon.className = 'bi bi-check-square-fill';
                answersHeader.appendChild(icon);
                
                // Add text node
                answersHeader.appendChild(document.createTextNode(' Answer Options'));
                
                parentNode.insertBefore(answersHeader, answersCollection);
            }
            
            // Add "Add Answer" button
            const addAnswerBtn = document.createElement('button');
            addAnswerBtn.type = 'button';
            addAnswerBtn.className = 'btn btn-sm btn-outline-primary add-answer mt-2';
            
            // Create icon for button
            const btnIcon = document.createElement('i');
            btnIcon.className = 'bi bi-plus-circle';
            addAnswerBtn.appendChild(btnIcon);
            addAnswerBtn.appendChild(document.createTextNode(' Add Answer'));
            
            addAnswerBtn.addEventListener('click', function() {
                addAnswer(answersCollection);
            });
            
            // Insert add answer button after answers collection
            parentNode.insertBefore(addAnswerBtn, answersCollection.nextSibling);
        }
    } else {
        console.warn('Could not find answers collection for the new question. Answers may not be manageable.');
    }
    
    // Add "Remove Question" button
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-remove-item remove-question mt-2 float-end';
    
    const removeIcon = document.createElement('i');
    removeIcon.className = 'bi bi-trash-fill';
    removeBtn.appendChild(removeIcon);
    removeBtn.appendChild(document.createTextNode(' Remove Question'));
    
    removeBtn.addEventListener('click', function() {
        removeQuestion(removeBtn);
    });
    wrapper.appendChild(removeBtn);
    
    collection.appendChild(wrapper);
    collection.setAttribute('data-index', index + 1);
    
    updateQuestionNumbers();
}

function removeQuestion(button) {
    const questionItem = button.closest('.question-item');
    if (!questionItem) {
        console.error('Could not find question item to remove');
        return;
    }
    
    if (confirm('Are you sure you want to remove this question?')) {
        questionItem.remove();
        updateQuestionNumbers();
    }
}

function addAnswer(collection) {
    if (!collection) {
        console.error('Answers collection not found');
        return;
    }
    
    const prototype = collection.getAttribute('data-prototype');
    if (!prototype) {
        console.error('No prototype found for answers collection');
        return;
    }
    
    let index = parseInt(collection.getAttribute('data-index'));
    if (isNaN(index) || index < 0) {
        index = 0;
    }
    
    let newForm = prototype.replace(/__name__/g, index);
    
    // Create wrapper with proper structure
    const wrapper = document.createElement('div');
    wrapper.classList.add('nested-collection', 'answer-item', 'mb-2');
    
    // Create row container
    const row = document.createElement('div');
    row.className = 'row align-items-end';
    
    // Parse the prototype HTML to extract form fields
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = newForm;
    
    // Extract form fields - they should be in div elements
    const formFields = tempDiv.children;
    
    // Create columns for each field with proper Bootstrap classes
    // Field 1: Answer text (col-md-7)
    const textCol = document.createElement('div');
    textCol.className = 'col-md-7';
    if (formFields.length > 0) {
        const textField = formFields[0];
        // Add label and form control styling
        const label = textField.querySelector('label');
        if (label) {
            label.className = 'form-label small';
            label.textContent = 'Answer Text';
        }
        const input = textField.querySelector('input[type="text"]');
        if (input) {
            input.className = 'form-control form-control-sm';
        }
        textCol.appendChild(textField);
    }
    row.appendChild(textCol);
    
    // Field 2: isCorrect checkbox (col-md-2)
    const correctCol = document.createElement('div');
    correctCol.className = 'col-md-2';
    if (formFields.length > 1) {
        const correctField = formFields[0]; // After appending, index shifts
        const formCheck = document.createElement('div');
        formCheck.className = 'form-check';
        const checkbox = correctField.querySelector('input[type="checkbox"]');
        if (checkbox) {
            checkbox.className = 'form-check-input';
            checkbox.checked = false; // Ensure default is unchecked
        }
        const label = correctField.querySelector('label');
        if (label) {
            label.className = 'form-check-label small';
        }
        formCheck.appendChild(correctField);
        correctCol.appendChild(formCheck);
    }
    row.appendChild(correctCol);
    
    // Field 3: Order index (col-md-2)
    const orderCol = document.createElement('div');
    orderCol.className = 'col-md-2';
    if (formFields.length > 0) {
        const orderField = formFields[0]; // After appending, index shifts again
        const input = orderField.querySelector('input[type="number"]');
        if (input) {
            input.className = 'form-control form-control-sm';
            input.placeholder = 'Order';
            input.value = index; // Set default order to current index
        }
        orderCol.appendChild(orderField);
    }
    row.appendChild(orderCol);
    
    // Create remove button column (col-md-1)
    const removeCol = document.createElement('div');
    removeCol.className = 'col-md-1';
    
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-remove-item remove-answer w-100';
    
    const removeIcon = document.createElement('i');
    removeIcon.className = 'bi bi-x-lg';
    removeBtn.appendChild(removeIcon);
    
    removeBtn.addEventListener('click', function() {
        removeAnswer(removeBtn);
    });
    
    removeCol.appendChild(removeBtn);
    row.appendChild(removeCol);
    
    wrapper.appendChild(row);
    collection.appendChild(wrapper);
    collection.setAttribute('data-index', index + 1);
}

function removeAnswer(button) {
    const answerItem = button.closest('.answer-item');
    if (!answerItem) {
        console.error('Could not find answer item to remove');
        return;
    }
    
    const answersCollection = answerItem.closest('.answers-collection');
    if (!answersCollection) {
        console.error('Could not find answers collection');
        return;
    }
    
    const answerCount = answersCollection.querySelectorAll('.answer-item').length;
    
    if (answerCount <= MINIMUM_ANSWER_COUNT) {
        alert(`A question must have at least ${MINIMUM_ANSWER_COUNT} answers.`);
        return;
    }
    
    answerItem.remove();
}

function applyQuestionFieldStyling(questionWrapper) {
    // Apply consistent CSS classes to dynamically added question fields
    
    // Style text inputs and textareas
    const textInputs = questionWrapper.querySelectorAll('input[type="text"], textarea');
    textInputs.forEach(input => {
        if (!input.classList.contains('form-control')) {
            input.classList.add('form-control');
        }
    });
    
    // Style number inputs
    const numberInputs = questionWrapper.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
        if (!input.classList.contains('form-control')) {
            input.classList.add('form-control');
        }
    });
    
    // Style select elements
    const selects = questionWrapper.querySelectorAll('select');
    selects.forEach(select => {
        if (!select.classList.contains('form-select')) {
            select.classList.add('form-select');
        }
    });
    
    // Style checkboxes
    const checkboxes = questionWrapper.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        if (!checkbox.classList.contains('form-check-input')) {
            checkbox.classList.add('form-check-input');
        }
    });
    
    // Style labels
    const labels = questionWrapper.querySelectorAll('label');
    labels.forEach(label => {
        if (!label.classList.contains('form-label')) {
            label.classList.add('form-label');
        }
    });
}

function updateQuestionNumbers() {
    const questionItems = document.querySelectorAll('.question-item');
    questionItems.forEach((item, index) => {
        const badge = item.querySelector('.question-number-badge');
        if (badge) {
            // Clear existing content
            while (badge.firstChild) {
                badge.removeChild(badge.firstChild);
            }
            // Add icon and text safely
            const icon = document.createElement('i');
            icon.className = 'bi bi-question-circle-fill';
            badge.appendChild(icon);
            badge.appendChild(document.createTextNode(' Question #' + (index + 1)));
        }
        // Also update h5 headers for simpler styled versions
        const header = item.querySelector('h5');
        if (header && header.textContent.includes('Question #')) {
            header.textContent = 'Question #' + (index + 1);
        }
    });
}
</script>
