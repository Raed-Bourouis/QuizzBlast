{% extends 'base.html.twig' %}

{% block title %}Game Master - QuizzBlast{% endblock %}

{% block body %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card card-custom fade-in-up">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <h1 class="display-4 fw-bold mb-3">
                            <i class="bi bi-controller text-primary"></i>
                            Game Master
                        </h1>

                        <div class="alert alert-primary mb-4" role="alert">
                            <h3 class="h4 mb-3">Game Code</h3>
                            <div class="display-3 fw-bold text-primary mb-2">{{ session.code }}</div>
                            <p class="mb-0">Share this code with players to join the game</p>
                        </div>

                        <div class="alert alert-info" role="alert">
                            <strong>Status:</strong> <span id="status">{{ session.status }}</span>
                        </div>
                    </div>

                    <!-- Current Question Display -->
                    <div id="currentQuestionDisplay" class="mb-4 d-none">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h4 class="card-title mb-3">
                                    <i class="bi bi-question-circle-fill text-primary"></i>
                                    Current Question (<span id="questionNumber">1</span> of {{ session.quiz.questions|length }})
                                </h4>
                                <p class="card-text fs-5" id="currentQuestionText"></p>
                                <div class="mt-3">
                                    <strong>Answers received:</strong> 
                                    <span id="answersCount" class="badge bg-primary">0</span> / 
                                    <span id="totalPlayers">{{ session.participants|length }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Participants List -->
                    <div class="mb-4">
                        <h4 class="fw-bold mb-3">
                            <i class="bi bi-people-fill"></i>
                            Participants (<span id="participantCount">{{ session.participants|length }}</span>)
                        </h4>
                        <div class="list-group" id="participantsList">
                            {% for participant in session.participants %}
                                <div class="list-group-item d-flex justify-content-between align-items-center" id="participant-{{ participant.id }}">
                                    <div>
                                        <i class="bi bi-person-circle text-primary me-2"></i>
                                        <strong>{{ participant.nickname }}</strong>
                                        {% if participant.isHost %}
                                            <span class="badge bg-warning text-dark ms-2">
                                                <i class="bi bi-star-fill"></i> Host
                                            </span>
                                        {% endif %}
                                    </div>
                                    <span class="badge bg-primary rounded-pill" id="score-{{ participant.id }}">
                                        {{ participant.totalScore }} pts
                                    </span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <div class="d-grid gap-2">
                        <button id="startGameBtn" class="btn btn-success btn-lg" 
                            {% if session.status != 'WAITING' %}disabled{% endif %}>
                            <i class="bi bi-play-circle-fill"></i> Start Game
                        </button>
                        <button id="nextQuestionBtn" class="btn btn-primary btn-lg" 
                            {% if session.status != 'IN_PROGRESS' %}disabled{% endif %}>
                            <i class="bi bi-arrow-right-circle-fill"></i> Next Question
                        </button>
                        <button id="endGameBtn" class="btn btn-danger btn-lg" 
                            {% if session.status != 'IN_PROGRESS' %}disabled{% endif %}>
                            <i class="bi bi-stop-circle-fill"></i> End Game
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const sessionId = {{ session.id }};
    const sessionCode = "{{ session.code }}";
    const quizQuestions = {{ session.quiz.questions|json_encode|raw }};
    const totalQuestions = quizQuestions.length;
    
    let pollInterval;
    let currentQuestionIndex = {{ session.currentQuestionIndex }};
    let currentStatus = '{{ session.status }}';

    const startBtn = document.getElementById('startGameBtn');
    const nextBtn = document.getElementById('nextQuestionBtn');
    const endBtn = document.getElementById('endGameBtn');
    const statusSpan = document.getElementById('status');

    // Start polling for updates
    pollInterval = setInterval(pollForUpdates, 2000);

    async function pollForUpdates() {
        try {
            const response = await fetch(`/api/game/session/${sessionId}/state`);
            const data = await response.json();

            if (response.ok) {
                // Update status
                if (data.status !== currentStatus) {
                    currentStatus = data.status;
                    statusSpan.textContent = currentStatus;
                    updateButtons(currentStatus);
                }

                // Update question index
                if (data.currentQuestionIndex !== currentQuestionIndex) {
                    currentQuestionIndex = data.currentQuestionIndex;
                    updateCurrentQuestion();
                }

                // Update participants list
                updateParticipantsList(data.players);

                // Check if game ended
                if (data.status === 'FINISHED') {
                    clearInterval(pollInterval);
                    setTimeout(() => {
                        window.location.href = `/game/${sessionCode}/leaderboard`;
                    }, 2000);
                }
            }
        } catch (error) {
            console.error('Error polling for updates:', error);
        }
    }

    function updateButtons(status) {
        startBtn.disabled = status !== 'WAITING';
        nextBtn.disabled = status !== 'IN_PROGRESS';
        endBtn.disabled = status !== 'IN_PROGRESS';
    }

    function updateCurrentQuestion() {
        if (currentStatus === 'IN_PROGRESS' && currentQuestionIndex < totalQuestions) {
            const question = quizQuestions[currentQuestionIndex];
            document.getElementById('currentQuestionDisplay').classList.remove('d-none');
            document.getElementById('questionNumber').textContent = currentQuestionIndex + 1;
            document.getElementById('currentQuestionText').textContent = question.text;
            document.getElementById('answersCount').textContent = '0';
        } else {
            document.getElementById('currentQuestionDisplay').classList.add('d-none');
        }
    }

    function updateParticipantsList(players) {
        const list = document.getElementById('participantsList');
        document.getElementById('participantCount').textContent = players.length;
        document.getElementById('totalPlayers').textContent = players.length;
        
        list.innerHTML = '';
        players.forEach(player => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <div>
                    <i class="bi bi-person-circle text-primary me-2"></i>
                    <strong>${escapeHtml(player.nickname)}</strong>
                    ${player.isHost ? '<span class="badge bg-warning text-dark ms-2"><i class="bi bi-star-fill"></i> Host</span>' : ''}
                </div>
                <span class="badge bg-primary rounded-pill">
                    ${player.score} pts
                </span>
            `;
            list.appendChild(item);
        });
    }

    // Start game button
    startBtn.addEventListener('click', async () => {
        if (!confirm('Start the game now?')) return;
        
        startBtn.disabled = true;
        startBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Starting...';
        
        try {
            const response = await fetch(`/api/game/session/${sessionId}/start`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                currentStatus = data.status;
                statusSpan.textContent = currentStatus;
                updateButtons(currentStatus);
                updateCurrentQuestion();
            } else {
                alert('Error: ' + (data.error || 'Failed to start game'));
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="bi bi-play-circle-fill"></i> Start Game';
            }
        } catch (error) {
            console.error('Error starting game:', error);
            alert('Network error');
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="bi bi-play-circle-fill"></i> Start Game';
        }
    });

    // Next question button
    nextBtn.addEventListener('click', async () => {
        if (currentQuestionIndex >= totalQuestions - 1) {
            alert('This is the last question. Use "End Game" to finish.');
            return;
        }
        
        nextBtn.disabled = true;
        nextBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';
        
        try {
            const response = await fetch(`/api/game/session/${sessionId}/next`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                currentQuestionIndex = data.currentQuestionIndex;
                updateCurrentQuestion();
                nextBtn.disabled = false;
                nextBtn.innerHTML = '<i class="bi bi-arrow-right-circle-fill"></i> Next Question';
            } else {
                alert('Error: ' + (data.error || 'Failed to go to next question'));
                nextBtn.disabled = false;
                nextBtn.innerHTML = '<i class="bi bi-arrow-right-circle-fill"></i> Next Question';
            }
        } catch (error) {
            console.error('Error going to next question:', error);
            alert('Network error');
            nextBtn.disabled = false;
            nextBtn.innerHTML = '<i class="bi bi-arrow-right-circle-fill"></i> Next Question';
        }
    });

    // End game button
    endBtn.addEventListener('click', async () => {
        if (!confirm('End the game now? This will finalize all scores.')) return;
        
        endBtn.disabled = true;
        endBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Ending...';
        
        try {
            const response = await fetch(`/api/game/session/${sessionId}/end`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                currentStatus = data.status;
                statusSpan.textContent = currentStatus;
                clearInterval(pollInterval);
                window.location.href = `/game/${sessionCode}/leaderboard`;
            } else {
                alert('Error: ' + (data.error || 'Failed to end game'));
                endBtn.disabled = false;
                endBtn.innerHTML = '<i class="bi bi-stop-circle-fill"></i> End Game';
            }
        } catch (error) {
            console.error('Error ending game:', error);
            alert('Network error');
            endBtn.disabled = false;
            endBtn.innerHTML = '<i class="bi bi-stop-circle-fill"></i> End Game';
        }
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initial load
    if (currentStatus === 'IN_PROGRESS') {
        updateCurrentQuestion();
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        clearInterval(pollInterval);
    });
</script>
{% endblock %}
