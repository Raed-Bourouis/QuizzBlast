{% extends 'base.html.twig' %}

{% block title %}Create New Quiz - QuizzBlast{% endblock %}

{% block body %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-body p-4">
                    <h1 class="h2 fw-bold mb-4">Create New Quiz</h1>

                    {{ form_start(form) }}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form_label(form.title, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                {{ form_widget(form.title, {'attr': {'class': 'form-control'}}) }}
                                {{ form_errors(form.title) }}
                            </div>

                            <div class="col-md-6 mb-3">
                                {{ form_label(form.category, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                {{ form_widget(form.category, {'attr': {'class': 'form-select'}}) }}
                                {{ form_errors(form.category) }}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form_label(form.description, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                            {{ form_widget(form.description, {'attr': {'class': 'form-control', 'rows': '3'}}) }}
                            {{ form_errors(form.description) }}
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form_label(form.difficulty, null, {'label_attr': {'class': 'form-label fw-bold'}}) }}
                                {{ form_widget(form.difficulty, {'attr': {'class': 'form-select'}}) }}
                                {{ form_errors(form.difficulty) }}
                            </div>

                            <div class="col-md-4 mb-3">
                                <div class="form-check mt-4 pt-2">
                                    {{ form_widget(form.isPublic, {'attr': {'class': 'form-check-input'}}) }}
                                    {{ form_label(form.isPublic, null, {'label_attr': {'class': 'form-check-label'}}) }}
                                    {{ form_errors(form.isPublic) }}
                                </div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <div class="form-check mt-4 pt-2">
                                    {{ form_widget(form.isActive, {'attr': {'class': 'form-check-input'}}) }}
                                    {{ form_label(form.isActive, null, {'label_attr': {'class': 'form-check-label'}}) }}
                                    {{ form_errors(form.isActive) }}
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <h3 class="h4 fw-bold mb-3">Questions</h3>
                        <div class="questions-collection" data-prototype="{{ form_widget(form.questions.vars.prototype)|e('html_attr') }}" data-index="{{ form.questions|length }}">
                            {% for question in form.questions %}
                                <div class="collection-item question-item mb-3">
                                    <h5 class="fw-bold mb-3">Question #{{ loop.index }}</h5>
                                    
                                    <div class="mb-3">
                                        {{ form_label(question.text, null, {'label_attr': {'class': 'form-label'}}) }}
                                        {{ form_widget(question.text, {'attr': {'class': 'form-control'}}) }}
                                        {{ form_errors(question.text) }}
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            {{ form_label(question.questionType, null, {'label_attr': {'class': 'form-label'}}) }}
                                            {{ form_widget(question.questionType, {'attr': {'class': 'form-select'}}) }}
                                            {{ form_errors(question.questionType) }}
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            {{ form_label(question.points, null, {'label_attr': {'class': 'form-label'}}) }}
                                            {{ form_widget(question.points, {'attr': {'class': 'form-control'}}) }}
                                            {{ form_errors(question.points) }}
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            {{ form_label(question.timeLimit, null, {'label_attr': {'class': 'form-label'}}) }}
                                            {{ form_widget(question.timeLimit, {'attr': {'class': 'form-control'}}) }}
                                            {{ form_errors(question.timeLimit) }}
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        {{ form_label(question.mediaUrl, null, {'label_attr': {'class': 'form-label'}}) }}
                                        {{ form_widget(question.mediaUrl, {'attr': {'class': 'form-control'}}) }}
                                        {{ form_errors(question.mediaUrl) }}
                                    </div>
                                    
                                    <h6 class="fw-bold mb-2">Answers</h6>
                                    <div class="answers-collection" data-prototype="{{ form_widget(question.answers.vars.prototype)|e('html_attr') }}" data-index="{{ question.answers|length }}">
                                        {% for answer in question.answers %}
                                            <div class="nested-collection answer-item mb-2">
                                                <div class="row align-items-end">
                                                    <div class="col-md-7">
                                                        {{ form_label(answer.text, 'Answer Text', {'label_attr': {'class': 'form-label small'}}) }}
                                                        {{ form_widget(answer.text, {'attr': {'class': 'form-control form-control-sm'}}) }}
                                                        {{ form_errors(answer.text) }}
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="form-check">
                                                            {{ form_widget(answer.isCorrect, {'attr': {'class': 'form-check-input'}}) }}
                                                            {{ form_label(answer.isCorrect, null, {'label_attr': {'class': 'form-check-label small'}}) }}
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        {{ form_widget(answer.orderIndex, {'attr': {'class': 'form-control form-control-sm', 'placeholder': 'Order'}}) }}
                                                    </div>
                                                    <div class="col-md-1">
                                                        <button type="button" class="btn btn-sm btn-danger remove-answer w-100">Ã—</button>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary add-answer mt-2">+ Add Answer</button>
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-question mt-2 float-end">Remove Question</button>
                                </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-success add-question mb-4">+ Add Question</button>

                        <div class="d-flex gap-2 justify-content-end">
                            <a href="{{ path('app_quiz_index') }}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Create Quiz</button>
                        </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to add a new question
    const questionsCollection = document.querySelector('.questions-collection');
    const addQuestionButton = document.querySelector('.add-question');
    
    if (addQuestionButton) {
        addQuestionButton.addEventListener('click', function() {
            addQuestion(questionsCollection);
        });
    }
    
    // Add event listeners to existing remove question buttons
    document.querySelectorAll('.remove-question').forEach(function(button) {
        button.addEventListener('click', function() {
            removeQuestion(button);
        });
    });
    
    // Add event listeners to existing add answer buttons
    document.querySelectorAll('.add-answer').forEach(function(button) {
        button.addEventListener('click', function() {
            const questionItem = button.closest('.question-item');
            const answersCollection = questionItem.querySelector('.answers-collection');
            addAnswer(answersCollection);
        });
    });
    
    // Add event listeners to existing remove answer buttons
    document.querySelectorAll('.remove-answer').forEach(function(button) {
        button.addEventListener('click', function() {
            removeAnswer(button);
        });
    });
    
    function addQuestion(collection) {
        const prototype = collection.getAttribute('data-prototype');
        if (!prototype) return;
        
        let index = parseInt(collection.getAttribute('data-index') || '0');
        
        // Replace '__name__' placeholder with the actual index
        let newForm = prototype.replace(/__name__/g, index);
        
        // Create a wrapper div for the new question
        const wrapper = document.createElement('div');
        wrapper.classList.add('collection-item', 'question-item');
        wrapper.innerHTML = newForm;
        
        // Find the answers collection in the new form and update its data-index
        const answersCollection = wrapper.querySelector('.answers-collection');
        if (answersCollection) {
            answersCollection.setAttribute('data-index', '0');
            
            // Add "Add Answer" button
            const addAnswerBtn = document.createElement('button');
            addAnswerBtn.type = 'button';
            addAnswerBtn.className = 'btn add-answer';
            addAnswerBtn.textContent = 'Add Answer';
            addAnswerBtn.addEventListener('click', function() {
                addAnswer(answersCollection);
            });
            wrapper.appendChild(addAnswerBtn);
        }
        
        // Add "Remove Question" button
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-secondary remove-question';
        removeBtn.textContent = 'Remove Question';
        removeBtn.addEventListener('click', function() {
            removeQuestion(removeBtn);
        });
        wrapper.appendChild(removeBtn);
        
        // Add the new question to the collection
        collection.appendChild(wrapper);
        
        // Increment the index
        collection.setAttribute('data-index', index + 1);
    }
    
    function removeQuestion(button) {
        const questionItem = button.closest('.question-item');
        questionItem.remove();
    }
    
    function addAnswer(collection) {
        const prototype = collection.getAttribute('data-prototype');
        if (!prototype) return;
        
        let index = parseInt(collection.getAttribute('data-index') || '0');
        
        // Replace '__name__' placeholder with the actual index
        let newForm = prototype.replace(/__name__/g, index);
        
        // Create a wrapper div for the new answer
        const wrapper = document.createElement('div');
        wrapper.classList.add('nested-collection', 'answer-item');
        wrapper.innerHTML = newForm;
        
        // Add "Remove Answer" button
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-secondary remove-answer';
        removeBtn.textContent = 'Remove Answer';
        removeBtn.addEventListener('click', function() {
            removeAnswer(removeBtn);
        });
        wrapper.appendChild(removeBtn);
        
        // Add the new answer to the collection
        collection.appendChild(wrapper);
        
        // Increment the index
        collection.setAttribute('data-index', index + 1);
    }
    
    function removeAnswer(button) {
        const answerItem = button.closest('.answer-item');
        answerItem.remove();
    }
});
</script>
{% endblock %}
